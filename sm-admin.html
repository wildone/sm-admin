<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-module-login/sm-module-login.html"> <link rel="import" href="../sm-module-save/sm-module-save.html"> <link rel="import" href="../sm-module-notify/sm-module-notify.html"> <link rel="import" href="../sm-utility-auth/sm-utility-auth.html"> <link rel="import" href="../sm-utility-share/sm-utility-share.html"> <link rel="import" href="../sm-ui-toolbar/sm-ui-toolbar.html"> <link rel="import" href="../simpla-block/simpla-block.html"> <script src="../fetch/fetch.js"></script> <script src="../es6-promise/es6-promise.min.js"></script> <dom-module id="sm-admin"> <template> <style include="sm-css"></style> <style>:host *{z-index:var(--on-top)}.save{position:fixed;top:12px;right:12px}</style> <template is="dom-if" if="{{_edit}}" restamp=""> <template is="dom-if" if="{{_notAuthenticated}}" restamp=""> <sm-module-login id="login" class="login"></sm-module-login> </template> <template is="dom-if" if="{{_authenticated}}" restamp=""> <sm-module-save id="save" class="save"></sm-module-save> </template> </template> <sm-ui-toolbar id="toolbar" hidden="{{!_editable}}"></sm-ui-toolbar> <sm-module-notify id="notify" class="notify"></sm-module-notify> <sm-utility-auth id="auth" token="{{_token}}" authenticated="{{_authenticated}}"></sm-utility-auth> <sm-utility-share type="state" key="editable" value="{{_editable}}"></sm-utility-share> <sm-utility-share type="singletons" key="toolbar" value="{{_toolbar}}"></sm-utility-share> </template> <script>!function(){"use strict";function e(){var e=void 0,t=void 0,n=void 0;e=document.body,n=document.createElement("sm-block-namespace"),n.block=e,Object.defineProperty(e,"sid",{get:function(){return this._smNamespace.gid},set:function(e){this._smNamespace.gid=e},enumerable:!0}),Object.defineProperty(e,"gid",{get:function(){return this._smNamespace.gid},set:function(e){this._smNamespace.gid=e},enumerable:!0}),e.gid=e.getAttribute("gid")||e.getAttribute("sid")||"",t=document.createElement("sm-admin"),e.appendChild(t)}function t(e){window.simpla=window.simpla||{},window.simpla.config=Object.assign({},e,window.simpla.config)}function n(){function e(){var e=document.querySelectorAll("simpla-text, simpla-img").length;fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({elements:e})})}function t(){var e=window.localStorage.getItem(c),t=Date.now();return e&&parseInt(e)>t}function n(){window.localStorage.setItem(c,Date.now()+u)}var i=simpla.config,a=i.api,o=i.server,r=o+"/projects/"+a+"/sessions";t()||e(),n(),window.addEventListener("beforeunload",function(){n()})}function i(e){var t=(new Date).getTime()/1e3,n=void 0;if(!e)return!0;try{var i=e.split("."),o=a.slicedToArray(i,2),r=o[1];n=JSON.parse(atob(r))}catch(s){return console.warn("Invalid token",s.message),!1}return n.exp&&t>n.exp?!1:!(!n.iss||n.iss!==m)}var a={};a.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a.slicedToArray=function(){function e(e,t){var n=[],i=!0,a=!1,o=void 0;try{for(var r,s=e[Symbol.iterator]();!(i=(r=s.next()).done)&&(n.push(r.value),!t||n.length!==t);i=!0);}catch(d){a=!0,o=d}finally{try{!i&&s["return"]&&s["return"]()}finally{if(a)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var o={ready:function(){var e=this;window.simpla=window.simpla||{},window.simpla.editMode=function(t){var n=t?window.removeEventListener:window.addEventListener;e._edit=t,n("hashchange",e._updateEditFromHash)}}},r="editing",s="viewing",d={observers:["_emitEditingOrViewing(_editable)"],_emitEditingOrViewing:function(e){var t=e?r:s;window.Simpla&&window.Simpla.client&&window.Simpla.client.emit&&this.debounce("emitting-"+t,function(){window.Simpla.client.emit(t)})}},c="sm-session",l=1e3,u=10*l,m="https://simpla.auth0.com/",p="edit",h="https://api.simpla.io",w=function(){function e(){a.classCallCheck(this,e)}return a.createClass(e,[{key:"beforeRegister",value:function(){this.is="sm-admin",this.properties={_authenticated:{type:Boolean,observer:"_authenticatedChanged"},_notAuthenticated:{type:Boolean,computed:"_computeNotAuthenticated(_authenticated)",value:!0},_edit:{type:Boolean,value:!1},_editable:Boolean,_token:String},this.observers=["_updateEditable(_authenticated, _edit)"]}},{key:"ready",value:function(){var e=this;this._updateEditFromHash=function(){e._edit=window.location.hash.split("#").pop()===p};var t=void 0;window.simpla=window.simpla||{},window.simpla.notifications=this.$.notify,window.addEventListener("hashchange",this._updateEditFromHash),this._toolbar=this.$.toolbar,this._updateEditFromHash(),t=window.localStorage.getItem("sm-token"),i(t)?this._token=t:window.localStorage.removeItem("sm-token")}},{key:"_computeNotAuthenticated",value:function(e){return!e}},{key:"_updateEditable",value:function(e,t){this._editable=e&&t}},{key:"_authenticatedChanged",value:function(e,t){t&&!e&&(window.location.hash=""),e&&this.fire("logged-in")}},{key:"behaviors",get:function(){return[o,d]}}]),e}();"complete"===document.readyState||"interactive"===document.readyState?(e(),n()):(document.addEventListener("DOMContentLoaded",e),document.addEventListener("DOMContentLoaded",n)),t({server:h,api:null}),Polymer(w)}()</script> </dom-module>