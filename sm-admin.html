<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-module-login/sm-module-login.html"> <link rel="import" href="../sm-module-save/sm-module-save.html"> <link rel="import" href="../sm-module-notify/sm-module-notify.html"> <link rel="import" href="../sm-utility-auth/sm-utility-auth.html"> <link rel="import" href="../sm-utility-share/sm-utility-share.html"> <link rel="import" href="../sm-ui-toolbar/sm-ui-toolbar.html"> <link rel="import" href="../simpla-block/simpla-block.html"> <script src="../fetch/fetch.js"></script><script src="../es6-promise/es6-promise.min.js"></script><dom-module id="sm-admin"> <template> <style include="sm-css"></style><style>:host *{z-index:var(--on-top)}.save{position:fixed;top:12px;right:12px}</style><template is="dom-if" if="{{_edit}}" restamp=""> <template is="dom-if" if="{{_notAuthenticated}}" restamp=""> <sm-module-login id="login" class="login"></sm-module-login> </template> <template is="dom-if" if="{{_authenticated}}" restamp=""> <sm-module-save id="save" class="save"></sm-module-save> </template> </template> <sm-ui-toolbar id="toolbar" hidden="{{!_edit}}"></sm-ui-toolbar> <sm-module-notify id="notify" class="notify"></sm-module-notify> <sm-utility-auth id="auth" token="{{_token}}" authenticated="{{_authenticated}}"></sm-utility-auth> <sm-utility-share type="state" key="editable" value="{{_editable}}"></sm-utility-share> <sm-utility-share type="singletons" key="toolbar" value="{{_toolbar}}"></sm-utility-share> </template> <script>!function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(){var e=void 0,t=void 0,n=void 0;e=document.body,n=document.createElement("sm-block-namespace"),n.block=e,Object.defineProperty(e,"sid",{get:function(){return this._smNamespace.gid},set:function(e){this._smNamespace.gid=e},enumerable:!0}),Object.defineProperty(e,"gid",{get:function(){return this._smNamespace.gid},set:function(e){this._smNamespace.gid=e},enumerable:!0}),e.gid=e.getAttribute("gid")||e.getAttribute("sid")||"",t=document.createElement("sm-admin"),e.appendChild(t)}function n(e){window.simpla=window.simpla||{},window.simpla.config=Object.assign({},e,window.simpla.config)}function i(){function e(){var e=document.querySelectorAll("simpla-text, simpla-img").length;fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({elements:e})})}function t(){var e=window.localStorage.getItem(d),t=Date.now();return e&&parseInt(e)>t}function n(){window.localStorage.setItem(d,Date.now()+c)}var i=simpla.config,o=i.api,a=i.server,r=a+"/projects/"+o+"/usage";t()||e(),n(),window.addEventListener("beforeunload",function(){n()})}function o(e){var t=(new Date).getTime()/1e3,n=void 0;if(!e)return!0;try{var i=e.split("."),o=r(i,2),a=o[1];n=JSON.parse(atob(a))}catch(s){return console.warn("Invalid token",s.message),!1}return n.exp&&t>n.exp?!1:n.iss&&n.iss===l?!0:!1}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(){function e(e,t){var n=[],i=!0,o=!1,a=void 0;try{for(var r,s=e[Symbol.iterator]();!(i=(r=s.next()).done)&&(n.push(r.value),!t||n.length!==t);i=!0);}catch(d){o=!0,a=d}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s={ready:function(){var e=this;window.simpla=window.simpla||{},window.simpla.editMode=function(t){var n=t?window.removeEventListener:window.addEventListener;e._edit=t,n("hashchange",e._updateEditFromHash)}}},d="sm-session",u=1e3,c=10*u,l="https://simpla.auth0.com/",m="edit",p="https://api.simpla.io",h=function(){function t(){e(this,t)}return a(t,[{key:"beforeRegister",value:function(){this.is="sm-admin",this.properties={_authenticated:{type:Boolean,observer:"_authenticatedChanged"},_notAuthenticated:{type:Boolean,computed:"_computeNotAuthenticated(_authenticated)",value:!0},_edit:{type:Boolean,value:!1},_editable:Boolean,_token:String},this.observers=["_updateEditable(_authenticated, _edit)"]}},{key:"ready",value:function(){var e=this;this._updateEditFromHash=function(){e._edit=window.location.hash.split("#").pop()===m};var t=void 0;window.simpla=window.simpla||{},window.simpla.notifications=this.$.notify,window.addEventListener("hashchange",this._updateEditFromHash),this._toolbar=this.$.toolbar,this._updateEditFromHash(),t=window.localStorage.getItem("sm-token"),o(t)?this._token=t:window.localStorage.removeItem("sm-token")}},{key:"_computeNotAuthenticated",value:function(e){return!e}},{key:"_updateEditable",value:function(e,t){this._editable=e&&t}},{key:"_authenticatedChanged",value:function(e,t){t&&!e&&(window.location.hash=""),e&&this.fire("logged-in")}},{key:"behaviors",get:function(){return[s]}}]),t}();"complete"===document.readyState||"interactive"===document.readyState?(t(),i()):(document.addEventListener("DOMContentLoaded",t),document.addEventListener("DOMContentLoaded",i)),n({server:p,api:null}),Polymer(h)}();</script></dom-module>