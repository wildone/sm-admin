<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-module-login/sm-module-login.html"> <link rel="import" href="../sm-module-save/sm-module-save.html"> <link rel="import" href="../sm-module-notify/sm-module-notify.html"> <link rel="import" href="../sm-utility-auth/sm-utility-auth.html"> <link rel="import" href="../sm-utility-share/sm-utility-share.html"> <link rel="import" href="../sm-ui-toolbar/sm-ui-toolbar.html"> <link rel="import" href="../simpla-block/simpla-block.html"> <dom-module id="sm-admin"> <template> <style include="sm-css"></style> <style>:host *{z-index:var(--on-top)}.save{position:fixed;top:12px;right:12px}</style> <template is="dom-if" if="{{_edit}}" restamp=""> <template is="dom-if" if="{{_notAuthenticated}}" restamp=""> <sm-module-login id="login" class="login"></sm-module-login> </template> <template is="dom-if" if="{{_authenticated}}" restamp=""> <sm-module-save id="save" class="save"></sm-module-save> </template> </template> <sm-ui-toolbar id="toolbar" hidden="{{!_edit}}"></sm-ui-toolbar> <sm-module-notify id="notify" class="notify"></sm-module-notify> <sm-utility-auth id="auth" token="{{_token}}" authenticated="{{_authenticated}}"></sm-utility-auth> <sm-utility-share type="state" key="editable" value="{{_editable}}"></sm-utility-share> <sm-utility-share type="singletons" key="toolbar" value="{{_toolbar}}"></sm-utility-share> </template> <script>(function () {
  'use strict';

  var editMode = {
    ready() {
      window.simpla = window.simpla || {};

      window.simpla.editMode = on => {
        let addOrRemove = on ? window.removeEventListener : window.addEventListener;
        this._edit = on;

        addOrRemove('hashchange', this._updateEditFromHash);
      };
    }
  };

  /**
   * When DOM is ready, inject admin and namespace body
   */
  function inject() {
    let body, admin, namespace;

    body = document.body;

    // Namespace
    namespace = document.createElement('sm-block-namespace');

    namespace.block = body;

    // Define getters / setters for sid and gid
    Object.defineProperty(body, 'sid', {
      get() {
        return this._smNamespace.gid;
      },
      set(value) {
        this._smNamespace.gid = value;
      },
      enumerable: true
    });

    Object.defineProperty(body, 'gid', {
      get() {
        return this._smNamespace.gid;
      },
      set(value) {
        this._smNamespace.gid = value;
      },
      enumerable: true
    });

    // Set initial value from attribute
    body.gid = body.getAttribute('gid') || body.getAttribute('sid') || '';

    // Append admin
    admin = document.createElement('sm-admin');
    body.appendChild(admin);
  }

  /**
   * Attach the given cofiguration to the global simpla object
   * @param  {Object} config Config object
   * @return {undefined}
   */
  function attachConfig(config) {
    window.simpla = window.simpla || {};

    // Allow the user's configuration to override the default given one
    window.simpla.config = Object.assign({}, config, window.simpla.config);
  }

  const EDIT = 'edit';
  const API_URL = 'https://api.simpla.io';
  class SmAdmin {
    beforeRegister() {
      this.is = 'sm-admin';

      this.properties = {
        _authenticated: {
          type: Boolean,
          observer: '_authenticatedChanged'
        },
        _notAuthenticated: {
          type: Boolean,
          computed: '_computeNotAuthenticated(_authenticated)',
          value: true
        },
        _edit: {
          type: Boolean,
          value: false
        },
        _editable: Boolean,
        _token: String
      };

      this.observers = ['_updateEditable(_authenticated, _edit)'];
    }

    get behaviors() {
      return [editMode];
    }

    ready() {
      // Needs to always be scoped to 'this', therefore added in ready
      this._updateEditFromHash = () => {
        this._edit = window.location.hash.split('#').pop() === EDIT;
      };

      let bodyMeta;

      window.simpla = window.simpla || {};
      window.simpla.notifications = this.$.notify;
      window.addEventListener('hashchange', this._updateEditFromHash);

      // Setup singleton instance
      this._toolbar = this.$.toolbar;

      // Setup state
      this._updateEditFromHash();
      this._token = window.localStorage.getItem('sm-token');

      // Setup body to take metadata
      bodyMeta = document.createElement('sm-meta-data');
      bodyMeta.block = document.body;
      bodyMeta.uid = encodeURIComponent(simpla.config.baseurl + window.location.pathname);
    }

    _computeNotAuthenticated(_authenticated) {
      return !_authenticated;
    }

    _updateEditable(_authenticated, _edit) {
      this._editable = _authenticated && _edit;
    }

    _authenticatedChanged(_authenticated, was) {
      if (was && !_authenticated) {
        window.location.hash = '';
      }
      if (_authenticated) {
        this.fire('logged-in');
      }
    }
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    inject();
  } else {
    document.addEventListener('DOMContentLoaded', inject);
  }

  attachConfig({
    server: API_URL,
    api: null
  });

  Polymer(SmAdmin);

}())</script> </dom-module>