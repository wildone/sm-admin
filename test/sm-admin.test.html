<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>sm-admin</title>
    <script src="../../webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">

    <!-- Import the element to test -->
    <link rel="import" href="../sm-admin.html">
    <script src="./sm-admin.fixtures.js"></script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <sm-admin></sm-admin>
      </template>
    </test-fixture>
    <test-fixture id="shared">
      <template>
        <sm-helper-share type="state" key="editable"></sm-helper-share>
      </template>
    </test-fixture>
    <test-fixture id="clickTree">
      <template>
        <div id="root">
          <div id="text-wrapper">
            <simpla-text id="text"></simpla-text>
          </div>
          <a id="img-wrapper">
            <simpla-img id="img"></simpla-img>
          </a>
          <div class="has-pointer">
            <div class="has-pointer"><simpla-img></simpla-img></div>
            <span class="no-pointer"><a href="#">foo</a></span>
          </div>
        </div>
      </template>
    </test-fixture>
    <script>
      describe('<sm-admin>', function() {

        var component,
            componentFixtures,
            hasElementById = function(id) {
              return !!component.$$('#' + id);
            },
            EVENT_TIMEOUT = 0,
            renderAll = function() {
              Polymer.dom(component.root).querySelectorAll('template')
                .forEach(function(template) { template.render(); });
            };

        componentFixtures = window.fixtures;

        beforeEach(function() {
          component = fixture('default');
          renderAll();
        });

        it('is okay', function() {
          expect(component).to.be.ok;
        });

        it('should not have any items when _edit is false', function() {
          component._edit = true;
          component._edit = false;
          component._authenticated = true;
          [ 'save', 'login', 'notify' ]
            .forEach(function(id) {
              expect(hasElementById(id)).to.be.false;
            });
        });

        describe('when _authenticated is true', function() {
          beforeEach(function() {
            component._edit = true;
            component._authenticated = true;
            renderAll();
          });

          it('should show save and notify', function() {
            expect(hasElementById('save')).to.be.true;
            expect(hasElementById('notify')).to.be.true;
          });

          it('should not show login', function() {
            expect(hasElementById('login')).to.be.false;
          });
        });

        describe('when _authenticated is false', function() {
          beforeEach(function() {
            component._authenticated = false;
            component._edit = true;
            renderAll();
          });

          it('should not show save and notify', function() {
            expect(hasElementById('save')).to.be.false;
            expect(hasElementById('notify')).to.be.false;
          });

          it('should show login', function() {
            expect(hasElementById('login')).to.be.true;
          });
        });

        it('_edit should be true when window.location.hash = "edit"', function(done) {
          window.location.hash = 'edit';

          setTimeout(function() {
            expect(component._edit).to.be.true;
            done();
          }, EVENT_TIMEOUT);
        });

        it('_edit should not be true when window.location.hash != "edit"', function(done) {
          window.location.hash = 'noedit';

          setTimeout(function() {
            expect(component._edit).to.not.be.true;
            done();
          }, EVENT_TIMEOUT);
        });

        it('should be bound to auth.authenticated', function() {
          component.$.auth.authenticated = true;
          expect(component._authenticated).to.be.true;
        });

        it('should remove #edit when not authenticated', function() {
          window.location.hash = 'edit';

          component._authenticated = true;
          component._authenticated = false;

          expect(window.location.hash).to.not.equal('#edit');
        });

        describe('editable', function() {
          it('should be bound to shared editable', function() {
            var shared = fixture('shared');
            shared.value = false;
            expect(component._editable).to.be.false;

            shared.value = true;
            expect(component._editable).to.be.true;

            component._editable = false;
            expect(shared.value).to.be.false;
          });

          it('should be true when _authenticated and _edit are both true', function() {
            expect(component._editable).to.not.be.true;

            component._edit = true;
            expect(component._editable).to.not.be.true;

            component._authenticated = true;
            expect(component._editable).to.be.true;

            component._edit = false;
            expect(component._editable).to.not.be.true;
          });
        });

        describe('click events', function() {
          var tree,

              text,
              textWrapper,
              textClickListener,

              img,
              imgWrapper,
              imgClickListener,

              hasPointers,
              noPointers;

          beforeEach(function() {
            tree = fixture('clickTree');

            normalClickListener = sinon.stub();
            textClickListener = sinon.stub();
            imgClickListener = sinon.stub();

            text = tree.querySelector('#text');
            textWrapper = tree.querySelector('#text-wrapper');
            textWrapper.addEventListener('click', textClickListener);

            img = tree.querySelector('#img');
            imgWrapper = tree.querySelector('#img-wrapper');
            imgWrapper.addEventListener('click', imgClickListener);

            hasPointers = [].slice.call(tree.querySelectorAll('.has-pointer'));
            noPointers = [].slice.call(tree.querySelectorAll('.no-pointer'));
          });

          it('should work as normal dom when not applied', function() {
            img.click();
            expect(imgClickListener.called).to.be.true;

            text.click();
            expect(textClickListener.called).to.be.true;
          });

          it('not reach parent elements when click events disabled', function() {
            component._disableClickEvents(tree);

            img.click();
            expect(imgClickListener.called).to.be.false;

            text.click();
            expect(textClickListener.called).to.be.false;
          });

          it('should completely disable branches without simpla-* inside it', function() {
            component._disableClickEvents(tree);

            hasPointers.forEach(function(element) {
              expect(element.style.pointerEvents).to.not.equal('none');
            });

            noPointers.forEach(function(element) {
              expect(element.style.pointerEvents).to.equal('none');
            });
          });

          it('should reenable as necessary', function() {
            component._disableClickEvents(tree);
            component._enableClickEvents(tree);

            hasPointers.forEach(function(element) {
              expect(element.style.pointerEvents).to.not.equal('none');
            });

            noPointers.forEach(function(element) {
              expect(element.style.pointerEvents).to.not.equal('none');
            });

            // Simpla stuff
            img.click();
            expect(imgClickListener.called).to.be.true;

            text.click();
            expect(textClickListener.called).to.be.true;
          });
        });
      });
    </script>
  </body>
</html>
